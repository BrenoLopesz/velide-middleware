# .github/workflows/create-release.yml

name: "Create Release"

on:
  push:
    tags:
      - "*"

jobs:
  build-and-release:
    name: "Build Project"
    # Inno Setup requires a Windows environment
    runs-on: "windows-latest"
    permissions:
      contents: write

    steps:
      - name: "01. Checkout code"
        uses: "actions/checkout@v4"

      - name: "02. Set up uv"
        uses: astral-sh/setup-uv@v5
        with:
          # uv will automatically install Python 3.8 because we ask for it here
          python-version: "3.8"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "03. Install dependencies"
        # --frozen ensures we use the EXACT versions from uv.lock
        run: uv sync --frozen

      - name: "04. Create version.txt file"
        # Saves version to a file. The 'shell: bash' is needed for this syntax.
        run: echo "${{ github.ref_name }}" > installer/resources/version.txt
        shell: bash

      - name: "05. Build Python executables"
        # We use 'uv run' to execute commands inside the environment created by 'uv sync'
        run: |
          uv run python installer/src/cli/setup_installer.py build
          uv run python installer/src/cli/setup.py build

      - name: "06. Compile 32-bit Inno Setup Installer"
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: "output/installer/resources/installer.iss"
          options: |
            /o+
            /DMyArch=x86
            /DMyAppVersion=v${{ github.ref_name }}

      - name: "07. Compile 64-bit Inno Setup Installer"
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: "output/installer/resources/installer.iss"
          options: |
            /o+
            /DMyArch=x64
            /DMyAppVersion=v${{ github.ref_name }}

      - name: "08. Clean up build artifacts"
        run: Remove-Item -Path './output/installer', './output/middleware' -Recurse -Force -ErrorAction SilentlyContinue

      - name: "09. Generate and Sign Hashes"
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_PRIVATE_KEY }}
        shell: pwsh # Use PowerShell for its robust error handling
        run: |
          try {
            # Write the key to a temporary file
            Set-Content -Path "private_key.pem" -Value "$env:SIGNING_KEY"
            
            # Run signing script
            uv run python installer/src/cli/prepare_update.py output --key private_key.pem --output output/manifest.json
          }
          finally {
            # This will always run, even if the python script fails
            Remove-Item -Path "private_key.pem" -ErrorAction SilentlyContinue
          }

      - name: "10. Create Release and Upload Assets"
        uses: softprops/action-gh-release@v1
        with:
          # The release name will be the tag name
          name: "Atualização ${{ github.ref_name }}"
          body: |
            Nova versão: ${{ github.ref_name }}.
            Arquivos de instalação estão listados abaixo.
          # Use a glob pattern to find all your assets in the output directory
          files: |
            ./output/velide_install_x86.exe
            ./output/velide_install_x64.exe
            ./output/manifest.json
            ./output/manifest.sig
